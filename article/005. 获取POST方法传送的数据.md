# 005. 获取POST方法传送的数据

作为一种HTTP请求方法，POST用于向指定的资源提交要被处理的数据。我们在某网站注册用户、写文章等时候，需要将数据传递到网站服务器中。并不适合将数据放到URL参数中，密码放到URL参数中容易被看到，文章数据又太多，浏览器不一定支持太长长度的URL。这时，一般使用POST方法。  


本文使用python的requests库模拟浏览器。

安装方法：
```
$ sudo pip3 install requests
```

### 5.1 建立Flask项目

按照以下命令建立Flask项目HelloWorld:
```
mkdir HelloWorld
mkdir HelloWorld/static
mkdir HelloWorld/templates
touch HelloWorld/server.py
```

### 5.2 查看POST数据内容

以用户注册为例子，我们需要向服务器`/register`传送用户名`name`和密码`password`。如下编写`HelloWorld/server.py`。
```python
from flask import Flask, request

app = Flask(__name__)


@app.route('/')
def hello_world():
    return 'hello world'


@app.route('/register', methods=['POST'])
def register():
    print(request.headers)
    print(request.stream.read())
    return 'welcome'


if __name__ == '__main__':
    app.run(port=5000, debug=True)
```

`@app.route('/register', methods=['POST'])`是指url`/register`只接受POST方法。可以根据需要修改`methods`参数，例如如果想要让它同时支持GET和POST，这样写：
```
@app.route('/register', methods=['GET', 'POST']) 
```

浏览器模拟工具`client.py`内容如下：
```
import requests

user_info = {'name': 'letian', 'password': '123'}
r = requests.post("http://127.0.0.1:5000/register", data=user_info)

print(r.text)
```

运行`HelloWorld/server.py`，然后运行`client.py`。`client.py`将输出：

```
welcome
```

而`HelloWorld/server.py`在终端中输出以下调试信息（通过`print`输出）：

```
Host: 127.0.0.1:5000
User-Agent: python-requests/2.19.1
Accept-Encoding: gzip, deflate
Accept: */*
Connection: keep-alive
Content-Length: 24
Content-Type: application/x-www-form-urlencoded


b'name=letian&password=123'
```
前6行是client.py生成的HTTP请求头，由`print(request.headers)`输出。

请求体的数据，我们通过`print(request.stream.read())`输出，结果是：
```
b'name=letian&password=123'
```

### 5.3 解析POST数据
上面，我们看到post的数据内容是：
```
b'name=letian&password=123'
```
我们要想办法把我们要的name、password提取出来，怎么做呢？自己写？不用，Flask已经内置了解析器`request.form`。

我们将服务代码改成：
```python
from flask import Flask, request

app = Flask(__name__)

@app.route('/')
def hello_world():
    return 'hello world'


@app.route('/register', methods=['POST'])
def register():
    print(request.headers)
    # print(request.stream.read()) # 不要用，否则下面的form取不到数据
    print(request.form)
    print(request.form['name'])
    print(request.form.get('name'))
    print(request.form.getlist('name'))
    print(request.form.get('nickname', default='little apple'))
    return 'welcome'


if __name__ == '__main__':
    app.run(port=5000, debug=True)
```

执行`client.py`请求数据，服务器代码会在终端输出：
```
Host: 127.0.0.1:5000
User-Agent: python-requests/2.19.1
Accept-Encoding: gzip, deflate
Accept: */*
Connection: keep-alive
Content-Length: 24
Content-Type: application/x-www-form-urlencoded


ImmutableMultiDict([('name', 'letian'), ('password', '123')])
letian
letian
['letian']
little apple
```
`request.form`会自动解析数据。

`request.form['name']`和`request.form.get('name')`都可以获取`name`对应的值。对于`request.form.get()`可以为参数`default`指定值以作为默认值。所以：
```
print(request.form.get('nickname', default='little apple'))
```

输出的是默认值
	
```
little apple
```

如果`name`有多个值，可以使用`request.form.getlist('name')`，该方法将返回一个列表。我们将client.py改一下：

```
import requests

user_info = {'name': ['letian', 'letian2'], 'password': '123'}
r = requests.post("http://127.0.0.1:5000/register", data=user_info)

print(r.text)
```
此时运行`client.py`，`print(request.form.getlist('name'))`将输出：
```
[u'letian', u'letian2']
```

### 5.4 本节源码
https://github.com/letiantian/flask-tutorial/tree/master/demo/flask-demo-003


<!-- flask-tutorial-info -->


---

* 上一篇 [004. 获取 URL 参数](004.%20%E8%8E%B7%E5%8F%96%20URL%20%E5%8F%82%E6%95%B0.md)
* 下一篇 [006. 处理和响应JSON数据](006.%20%E5%A4%84%E7%90%86%E5%92%8C%E5%93%8D%E5%BA%94JSON%E6%95%B0%E6%8D%AE.md)

> 本教程讲述如何使用 Python Flask Web 框架，如有错误/建议，欢迎交流。

