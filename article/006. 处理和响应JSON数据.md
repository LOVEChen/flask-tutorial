# 006. 处理和响应JSON数据

使用 HTTP POST 方法传到网站服务器的数据格式可以有很多种，比如「5. 获取POST方法传送的数据」讲到的`name=letian&password=123`这种用过`&`符号分割的key-value键值对格式。我们也可以用JSON格式、XML格式。相比XML的重量、规范繁琐，JSON显得非常小巧和易用。


### 6.1 建立Flask项目

按照以下命令建立Flask项目HelloWorld:
```
mkdir HelloWorld
mkdir HelloWorld/static
mkdir HelloWorld/templates
touch HelloWorld/server.py
```

### 6.2 处理JSON格式的请求数据
如果POST的数据是JSON格式，`request.json`会自动将json数据转换成Python类型（字典或者列表）。

编写`server.py`:
```python
from flask import Flask, request

app = Flask("my-app")


@app.route('/')
def hello_world():
    return 'Hello World!'


@app.route('/add', methods=['POST'])
def add():
    print(request.headers)
    print(type(request.json))
    print(request.json)
    result = request.json['a'] + request.json['b']
    return str(result)


if __name__ == '__main__':
    app.run(host='127.0.0.1', port=5000, debug=True)
```

编写`client.py`模拟浏览器请求：
```
import requests

json_data = {'a': 1, 'b': 2}

r = requests.post("http://127.0.0.1:5000/add", json=json_data)

print(r.text)
```

运行`server.py`，然后运行`client.py`，`client.py` 会在终端输出：
```
3
```
`server.py` 会在终端输出：
```
Host: 127.0.0.1:5000
User-Agent: python-requests/2.19.1
Accept-Encoding: gzip, deflate
Accept: */*
Connection: keep-alive
Content-Length: 16
Content-Type: application/json


<class 'dict'>
{'a': 1, 'b': 2}
```
注意，请求头中`Content-Type`的值是`application/json`。

### 6.3 响应JSON-方案1

响应JSON时，除了要把响应体改成JSON格式，响应头的`Content-Type`也要设置为`application/json`。

编写`server2.py`：
```
from flask import Flask, request, Response
import json

app = Flask("my-app")


@app.route('/')
def hello_world():
    return 'Hello World!'


@app.route('/add', methods=['POST'])
def add():
    result = {'sum': request.json['a'] + request.json['b']}
    return Response(json.dumps(result),  mimetype='application/json')


if __name__ == '__main__':
    app.run(host='127.0.0.1', port=5000, debug=True)
```
修改后运行。

编写`client2.py`：
```
import requests

json_data = {'a': 1, 'b': 2}

r = requests.post("http://127.0.0.1:5000/add", json=json_data)

print(r.headers)
print(r.text)
```
运行`client.py`，将显示：
```
{'Content-Type': 'application/json', 'Content-Length': '10', 'Server': 'Werkzeug/0.14.1 Python/3.6.4', 'Date': 'Sat, 07 Jul 2018 05:23:00 GMT'}
{"sum": 3}
```
上面第一段内容是服务器的响应头，第二段内容是响应体，也就是服务器返回的JSON格式数据。


另外，如果需要服务器的HTTP响应头具有更好的可定制性，比如自定义`Server`，可以如下修改`add()`函数：
```
@app.route('/add', methods=['POST'])
def add():
    result = {'sum': request.json['a'] + request.json['b']}
    resp = Response(json.dumps(result),  mimetype='application/json')
    resp.headers.add('Server', 'python flask')
    return resp
```

`client2.py`运行后会输出：
```
{'Content-Type': 'application/json', 'Content-Length': '10', 'Server': 'python flask', 'Date': 'Sat, 07 Jul 2018 05:26:40 GMT'}
{"sum": 3}
```

### 6.4 响应JSON-方案2

使用 jsonify 工具函数即可。

```
from flask import Flask, request, jsonify

app = Flask("my-app")


@app.route('/')
def hello_world():
    return 'Hello World!'


@app.route('/add', methods=['POST'])
def add():
    result = {'sum': request.json['a'] + request.json['b']}
    return jsonify(result)


if __name__ == '__main__':
    app.run(host='127.0.0.1', port=5000, debug=True)
```

### 6.5 本节源码
https://github.com/letiantian/flask-tutorial/tree/master/demo/flask-demo-004


<!-- flask-tutorial-info -->


---

* 上一篇 [005. 获取POST方法传送的数据](005.%20%E8%8E%B7%E5%8F%96POST%E6%96%B9%E6%B3%95%E4%BC%A0%E9%80%81%E7%9A%84%E6%95%B0%E6%8D%AE.md)
* 下一篇 [007. 上传文件](007.%20%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6.md)

> 本教程讲述如何使用 Python Flask Web 框架，如有错误/建议，欢迎交流。

