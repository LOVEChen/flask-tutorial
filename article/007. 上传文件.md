# 007. 上传文件

上传文件，一般也是用POST方法。

### 7.1 建立Flask项目

按照以下命令建立Flask项目HelloWorld:
```
mkdir HelloWorld
mkdir HelloWorld/static
mkdir HelloWorld/templates
touch HelloWorld/server.py
```

### 7.2 上传文件

这一部分的代码参考自[How to upload a file to the server in Flask](http://runnable.com/UiPcaBXaxGNYAAAL/how-to-upload-a-file-to-the-server-in-flask-for-python)。  

我们以上传图片为例：
假设将上传的图片只允许'png'、'jpg'、'jpeg'、'gif'这四种格式，通过url`/upload`使用POST上传，上传的图片存放在服务器端的`static/uploads`目录下。

首先在项目`HelloWorld`中创建目录`static/uploads`：
```
mkdir HelloWorld/static/uploads
```

`werkzeug`库可以判断文件名是否安全，例如防止文件名是`../../../a.png`，安装这个库：
```
$ sudo pip3 install werkzeug
```

`server.py`代码：

```python
from flask import Flask, request

from werkzeug.utils import secure_filename
import os

app = Flask(__name__)

# 文件上传目录
app.config['UPLOAD_FOLDER'] = 'static/uploads/'
# 支持的文件格式
app.config['ALLOWED_EXTENSIONS'] = {'png', 'jpg', 'jpeg', 'gif'}  # 集合类型


# 判断文件名是否是我们支持的格式
def allowed_file(filename):
    return '.' in filename and \
           filename.rsplit('.', 1)[1] in app.config['ALLOWED_EXTENSIONS']


@app.route('/')
def hello_world():
    return 'hello world'


@app.route('/upload', methods=['POST'])
def upload():
    upload_file = request.files['image']
    if upload_file and allowed_file(upload_file.filename):
        filename = secure_filename(upload_file.filename)
        # 将文件保存到 static/uploads 目录，文件名同上传时使用的文件名
        upload_file.save(os.path.join(app.root_path, app.config['UPLOAD_FOLDER'], filename))
        return 'info is '+request.form.get('info', '')+'. success'
    else:
        return 'failed'


if __name__ == '__main__':
    app.run(port=5000, debug=True)
```
`app.config`中的config是字典的子类，可以用来设置自有的配置信息，也可以设置自己的配置信息。函数`allowed_file(filename)`用来判断`filename`是否有后缀以及后缀是否在`app.config['ALLOWED_EXTENSIONS']`中。

客户端上传的图片必须以`image01`标识。`upload_file`是上传文件对应的对象。`app.root_path`获取`server.py`所在目录在文件系统中的绝对路径。`upload_file.save(path)`用来将`upload_file`保存在服务器的文件系统中，参数最好是绝对路径，否则会报错（网上很多代码都是使用相对路径，但是笔者在使用相对路径时总是报错，说找不到路径）。函数`os.path.join()`用来将使用合适的路径分隔符将路径组合起来。

好了，定制客户端`client.py`：
```
import requests

file_data = {'image': open('Lenna.jpg', 'rb')}

user_info = {'info': 'Lenna'}

r = requests.post("http://127.0.0.1:5000/upload", data=user_info, files=file_data)

print(r.text)
```
运行`client.py`，当前目录下的`Lenna.jpg`将上传到服务器。

然后，我们可以在`static/uploads`中看到文件`Lenna.jpg`。

要控制上产文件的大小，可以设置请求实体的大小，例如：

```
app.config['MAX_CONTENT_LENGTH'] = 16 * 1024 * 1024 #16MB
```

不过，在处理上传文件时候，需要使用`try:...except:...`。

如果要获取上传文件的内容可以：
```
file_content = request.files['image'].stream.read()
```

### 7.3 本节源码
https://github.com/letiantian/flask-tutorial/tree/master/demo/flask-demo-005